# ============================================================
# Observability Stack Deployment (Prometheus + Grafana + Loki)
# ============================================================

- hosts: kafka
  become: yes
  vars_files:
    - vars/secrets.yml

  tasks:
    # ---------------------------
    # 1. Create network + secrets
    # ---------------------------
    - name: Create overlay network for observability
      community.docker.docker_network:
        name: metrics_net
        driver: overlay
        attachable: true
        state: present

    - name: Create Grafana secrets
      community.docker.docker_secret:
        name: "{{ item.name }}"
        data: "{{ item.data }}"
        state: present
      loop:
        - { name: grafana_user, data: "{{ grafana_admin_user }}" }
        - { name: grafana_pass, data: "{{ grafana_admin_password }}" }

    # ---------------------------
    # 2. Template stack
    # ---------------------------
    - name: Template Observability stack
      template:
        src: templates/obs_stack.yml.j2
        dest: /opt/stacks/obs_stack.yml
        mode: '0644'

    # ---------------------------
    # 3. Deploy stack fresh
    # ---------------------------
    - name: Remove existing Observability stack (if any)
      community.docker.docker_stack:
        name: obs
        state: absent
      ignore_errors: yes

    - name: Copy Prometheus config
      template:
        src: templates/prometheus.yml.j2
        dest: /etc/prometheus/prometheus.yml
        mode: '0644'

    - name: Ensure Grafana data directory exists on all nodes
      become: yes
      file:
        path: /var/lib/grafana
        state: directory
        owner: 472
        group: 472
        mode: '0775'
      delegate_to: "{{ item }}"
      with_items: "{{ groups['all'] }}"
      run_once: false

    - name: Deploy Observability stack
      community.docker.docker_stack:
        name: obs
        state: present
        compose:
          - /opt/stacks/obs_stack.yml

    # ---------------------------
    # 4. Smoke test / verification
    # ---------------------------
    - name: Show running Swarm services
      shell: docker service ls | grep obs_ || true
      register: obs_services
      changed_when: false

    - debug:
        var: obs_services.stdout_lines

    - name: Check Grafana service logs
      shell: docker service logs --tail 20 obs_grafana || true
      register: grafana_logs
      changed_when: false

    - debug:
        var: grafana_logs.stdout_lines
